<html>
    <header>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    </header>

    <body class="container-fluid">

        <div class="row mt-2">
            <div class="col-8"> 
                <input id="pageUrl" class="form-control" />
            </div>
            <div class="col-2">
                <button id="addBtn" class="btn btn-primary">Adicionar</button>
            </div>
        </div>

        <br>
        <hr>

        <div class="row">

            <div class="col-12" style="max-height: 500px; overflow-y: scroll;">

                <table id='urlTable' class="table">
                    <tr>
                        <th>URL</th>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </table>

            </div>           

        </div>

        <br>
        <hr>

        <div class="row mt-1">

            <div class="col-3">
                <input type="text" class="form-control" placeholder="email">
            </div>

            <div class="col-2">
                <button id="sendBtn" class="btn btn-secondary">Enviar</button>
            </div>

        </div>

    </body>

    <script>
        window.onload = () => {

            var urls = [];

            $('#pageUrl').focus();

            $('#addBtn').on('click', () => {

                let value = $('#pageUrl').val();

                if(!value) return;

                urls.push(value);
                
                $('#pageUrl').val('');

                renderTable();

                $('#pageUrl').focus();
            }); 

            $('#sendBtn').on('click', async () => {

                try {

                    if(!urls || urls.length == 0){
                        alert('Adicione pelo menos uma URL');

                        return;
                    }

                    await scrap();

                    alert('Solicitação enviada com sucesso');

                } catch (error) {
                    alert(error);
                }                
            }); 
            
            const renderTable = () => {

                $('#urlTable').find('[name="row"').remove();

                for(url of urls){
                    $('#urlTable tr:last').after(`<tr name="row"><td>${url}</td></tr>`);
                }
            }

            const scrap = async () => {

                let content = await (await fetch(`${window.location.origin}/api/process`, { method: 'POST', body: JSON.stringify({ urls }),   headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                    },})).text();

                var hiddenElement = document.createElement('a');                
                hiddenElement.href = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(content);
                hiddenElement.target = '_blank';
                hiddenElement.download = 'imoveis.csv';
                hiddenElement.click();
            }
        }
    </script>

</html>